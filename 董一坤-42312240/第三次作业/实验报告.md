# Android 实验报告 - Assignment 4

## 一、实验目的

1. 掌握使用 RadioGroup 控制 Fragment 切换的实现方法
2. 理解 Bundle 数据传递机制，实现 Activity 与 Fragment 之间的数据传递
3. 掌握屏幕旋转时状态保存的方法，使用 `onSaveInstanceState` 保存和恢复数据

## 二、实验环境

- 开发工具：Android Studio
- 开发语言：Java
- 最低支持版本：Android API 24
- 目标版本：Android API 34

## 三、实验内容与实现

### 3.1 RadioGroup 控制 Fragment 切换

#### 3.1.1 功能要求

实现一个包含 4 个 RadioButton 的 RadioGroup，每个 RadioButton 对应一个不同的 Fragment，点击 RadioButton 可以切换到对应的 Fragment。

#### 3.1.2 实现方案

**（1）布局设计**

在 `activity_first_main.xml` 中定义了 RadioGroup 和 4 个 RadioButton：

```xml
<RadioGroup
    android:id="@+id/rg_main"
    android:layout_width="match_parent"
    android:layout_height="wrap_content"
    android:orientation="horizontal">
    
    <RadioButton
        android:id="@+id/rb_home"
        style="@style/custom_radio_button"
        android:text="首页" />
        
    <RadioButton
        android:id="@+id/rb_export"
        style="@style/custom_radio_button"
        android:text="探索" />
        
    <RadioButton
        android:id="@+id/rb_message"
        style="@style/custom_radio_button"
        android:text="消息" />
        
    <RadioButton
        android:id="@+id/rb_person"
        style="@style/custom_radio_button"
        android:text="个人" />
</RadioGroup>
```

**（2）Fragment 定义**

创建了 4 个 Fragment 类，每个都有独特的 UI 和功能：

- `HomeFragment`：首页 Fragment，可以接收和返回数据
- `ExportFragment`：探索 Fragment，包含用户兴趣输入功能
- `MessageFragment`：消息 Fragment，显示消息内容
- `PersonFragment`：个人 Fragment，可以接收来自其他 Fragment 的数据

**（3）Fragment 切换逻辑**

在 `FirstMainActivity.java` 中实现 Fragment 切换：

```java
rg_main.setOnCheckedChangeListener((group, checkedId) -> {
    if(checkedId == R.id.rb_home) {
        switchFragment(mHomeFragment);
    }else if(checkedId == R.id.rb_export) {
        switchFragment(mExportFragment);
    }else if(checkedId == R.id.rb_message) {
        switchFragment(mMessageFragment);
    }else if(checkedId == R.id.rb_person) {
        switchFragment(mPersonFragment);
    }
});

protected void switchFragment(Fragment fragment){
    fragmentManager = getSupportFragmentManager();
    transaction = fragmentManager.beginTransaction();
    
    if(!fragment.isAdded()){
        transaction.add(R.id.fl_insert, fragment);
    }
    for(Fragment frag: fragments){
        if(frag.equals(fragment)){
            transaction.show(frag);
        }else{
            transaction.hide(frag);
        }
    }
    transaction.commit();
}
```

**（4）RadioButton 样式定义**

在 `values/themes.xml` 中定义了统一的 RadioButton 样式：

```xml
<style name="custom_radio_button">
    <item name="android:textSize">15sp</item>
    <item name="android:layout_height">50dp</item>
    <item name="android:layout_width">0dp</item>
    <item name="android:layout_weight">1</item>
    <item name="android:layout_margin">2dp</item>
    <item name="android:buttonTint">@color/custom_radio_button</item>
</style>
```

**（5）RadioButton 状态选择器**

在 `color/custom_radio_button.xml` 中定义了选中和未选中状态的颜色：

```xml
<selector xmlns:android="http://schemas.android.com/apk/res/android">
    <!-- 选中状态 -->
    <item android:color="#2196F3" android:state_checked="true"/>
    
    <!-- 未选中状态 -->
    <item android:color="#9E9E9E" android:state_checked="false"/>
    
    <!-- 默认状态 -->
    <item android:color="#9E9E9E"/>
</selector>
```

#### 3.1.3 功能特点

- 4 个 Fragment 具有不同的 UI 设计和功能
- 使用 show/hide 方式切换 Fragment，提高性能
- RadioButton 具有统一的样式和状态选择器
- 默认选中首页 Fragment

### 3.2 Bundle 数据传输

#### 3.2.1 场景 A：Activity → Activity

**功能描述**：从 `A_Activity` 传递用户数据（用户名、年龄、是否为学生）到 `B_Activity`。

**实现代码**：

在 `A_Activity.java` 中发送数据：

```java
String user_name = et_user_name.getText().toString();
String age = et_age.getText().toString();
boolean is_stu = rb_stu.isChecked();

Bundle info = new Bundle();
info.putString("user_name", user_name);
info.putString("age", age);
info.putBoolean("is_stu", is_stu);

Intent intent = new Intent(this, B_Activity.class);
intent.putExtra("info", info);
startActivity(intent);
```

在 `B_Activity.java` 中接收数据：

```java
Bundle info = getIntent().getBundleExtra("info");
if(info != null){
    String user_name = info.getString("user_name");
    String age = info.getString("age");
    boolean is_stu = info.getBoolean("is_stu");
    
    show_text = "根据你填写的信息可知：\n" + 
                "你在本应用上的用户名为：" + user_name + "\n" + 
                "你的年龄为：" + age + "\n" + 
                "你是否为一名学生：" + (is_stu?"是":"否");
}
tv_info.setText(show_text);
```

**实现效果**：用户输入数据后，点击"传递数据 Activity"按钮，数据成功传递到 `B_Activity` 并在 TextView 中显示。

#### 3.2.2 场景 B：Activity → Fragment

**功能描述**：`A_Activity` 传递初始数据到 `HomeFragment`，`Fragment` 处理后将结果返回给 `Activity`。

**实现代码**：

在 `A_Activity.java` 中传递数据并启动 Activity：

```java
Intent intent = new Intent(this, FirstMainActivity.class);
intent.putExtra("info", info);
startActivityForResult(intent, HOME_FRAGMENT_REQUEST_CODE);
```

在 `FirstMainActivity.java` 中将数据传递给 Fragment：

```java
Bundle info = getIntent().getBundleExtra("info");
mHomeFragment.setArguments(info);
if(info != null){
    mHomeFragment.setFragmentCallback(this::returnToFirstActivity);
}
```

在 `HomeFragment.java` 中接收数据并返回结果：

```java
// 接收数据
Bundle args = getArguments();
if (args != null) {
    String user_name = args.getString("user_name");
    String age = args.getString("age");
    boolean is_stu = args.getBoolean("is_stu");
    // 显示接收到的数据
    displayReceivedData();
}

// 返回处理结果
private void processData() {
    Bundle args = getArguments();
    String processedResult = "根据你填写的信息可知：\n" + 
                            "你在本应用上的用户名为：" + user_name + "\n" + 
                            "你的年龄为：" + age + "\n" + 
                            "你是否为一名学生：" + (is_stu?"是":"否");
    
    if (callback != null) {
        callback.onFragmentResult(processedResult);
    }
}
```

在 `FirstMainActivity.java` 中处理回调并返回结果：

```java
private void returnToFirstActivity(String result) {
    Intent resultIntent = new Intent();
    resultIntent.putExtra("final_result", result);
    setResult(RESULT_OK, resultIntent);
    finish();
}
```

在 `A_Activity.java` 中接收返回结果：

```java
@Override
protected void onActivityResult(int requestCode, int resultCode, @Nullable Intent data) {
    super.onActivityResult(requestCode, resultCode, data);
    
    if (requestCode == HOME_FRAGMENT_REQUEST_CODE && resultCode == RESULT_OK && data != null) {
        String result = data.getStringExtra("final_result");
        tv_res.setVisibility(View.VISIBLE);
        tv_res.setText(result);
    }
}
```

**实现效果**：用户点击"传递数据 Fragment"按钮后，数据传递到 `HomeFragment` 显示，点击"返回数据"按钮后，处理结果返回到 `A_Activity` 显示。

#### 3.2.3 场景 C：Fragment → Fragment

**功能描述**：数据在两个 Fragment 之间传递，使用 Activity 作为中介。

**实现代码**：

在 `ExportFragment.java` 中发送数据：

```java
btn_send.setOnClickListener(v->{
    String user_interest = et_user_interest.getText().toString();
    ((FirstMainActivity) requireActivity()).onDataFromExport(user_interest);
});
```

在 `FirstMainActivity.java` 中作为中介转发数据：

```java
public void onDataFromExport(String userInterest) {
    mPersonFragment.receiveData(userInterest);
    switchFragment(mPersonFragment);
}
```

在 `PersonFragment.java` 中接收数据：

```java
public void receiveData(String userInterest) {
    tv_res.setText("根据你填写的搜索记录，可知你的兴趣/爱好为：" + userInterest);
    tv_res.setVisibility(View.VISIBLE);
}
```

**实现效果**：用户在 `ExportFragment` 中输入兴趣/爱好并点击"提交"按钮，数据通过 `FirstMainActivity` 传递到 `PersonFragment`，并自动切换到个人页面显示结果。

### 3.3 屏幕旋转与状态保存 onSaveInstanceState

#### 3.3.1 功能要求

1. 记录 `onSaveInstanceState` 在 Android 生命周期中的调用时机
2. 在 `onSaveInstanceState` 中保存 `EditText` 的内容
3. 屏幕旋转后，将保存的内容显示在 `TextView` 中

#### 3.3.2 实现方案

**（1）保存状态**

在 `A_Activity.java` 中实现 `onSaveInstanceState` 方法：

```java
@Override
protected void onSaveInstanceState(@NonNull Bundle outState) {
    super.onSaveInstanceState(outState);
    
    outState.putString("user_name", et_user_name.getText().toString());
    outState.putString("age", et_age.getText().toString());
    outState.putBoolean("is_stu", rb_stu.isChecked());
    
    Log.d(TAG, "onSaveInstanceState: 保存屏幕旋转前的内容");
}
```

**（2）恢复状态**

在 `onCreate` 方法中检查并恢复保存的状态：

```java
@Override
protected void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);
    // ... 其他初始化代码
    
    if(savedInstanceState != null){
        String user_name = savedInstanceState.getString("user_name");
        String age = savedInstanceState.getString("age");
        boolean is_stu = savedInstanceState.getBoolean("is_stu");
        String desc = "你在这个应用的用户名为：" + user_name + "\n" + 
                     "年龄为：" + age + "\n" + 
                     "是否为学生：" + (is_stu?"是":"否");
        
        tv_res.setVisibility(View.VISIBLE);
        tv_res.setText(desc);
        
        Log.d(TAG, "onCreate: 屏幕已经旋转了");
    }
}
```

#### 3.3.3 生命周期分析

**`onSaveInstanceState` 调用时机**：

根据 Android 生命周期，`onSaveInstanceState` 在以下情况下被调用：

1. **Activity 被系统销毁之前**：当系统为了恢复内存而需要销毁 Activity 时
2. **屏幕旋转时**：在 `onPause()` 之后、`onStop()` 之前调用
3. **切换到后台时**：当应用进入后台，系统可能回收 Activity 时

**生命周期调用顺序**（屏幕旋转时）：

```
onPause() 
→ onSaveInstanceState() 
→ onStop() 
→ onDestroy() 
→ onCreate() 
→ onStart() 
→ onResume()
```

### 实验结果

<video src="./res/20251101_164949.mp4" controls autoplay></video>

<video src="./res/20251101_165807.mp4" controls></video>
