# Android应用 To-Do-List 开发实验报告

## 一、实验目的

1. 掌握ListView和自定义Adapter的使用方法
2. 学习Activity之间的数据传递和页面跳转
3. 掌握Android UI组件的使用，包括EditText、Button、CheckBox、DatePickerDialog等
4. 实现一个完整的待办事项（To-Do List）管理应用

## 二、实验环境

- 开发工具：Android Studio
- 开发语言：Java
- 目标平台：Android
- 数据库：SQLite

## 三、实验内容与要求

### 3.1 功能需求

开发一个待办事项管理应用，实现以下功能：

1. **主界面功能**
   - 显示所有待办事项列表
   - 支持关键词搜索功能
   - 点击列表项可查看/编辑任务详情
   - 添加新任务按钮

2. **任务详情界面功能**
   - 显示/编辑任务内容
   - 设置任务截止日期（使用日期选择器）
   - 标记任务是否完成
   - 标记任务是否重要
   - 支持添加新任务和更新已有任务

3. **数据存储**
   - 使用SQLite数据库持久化存储任务数据
   - 支持任务的增删改查操作

4. **UI显示**
   - 重要任务显示实心星标，普通任务显示空心星标
   - 已完成任务显示删除线效果
   - 显示任务内容和截止日期

## 四、系统设计

### 4.1 系统架构

本应用采用经典的MVC（Model-View-Controller）架构模式：

- **Model层**：`ToDoItem`（数据模型）、`MyDBHelper`（数据库操作）
- **View层**：XML布局文件（`activity_main.xml`、`activity_task_detail.xml`、`to_to_item.xml`）
- **Controller层**：`MainActivity`、`TaskDetailActivity`、`ToDoAdapter`

### 4.2 数据库设计

**表名**：`to_do_list`

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INTEGER PRIMARY KEY AUTOINCREMENT | 主键，自增 |
| TaskContent | TEXT | 任务内容 |
| TaskDate | TEXT | 任务截止日期 |
| done | INTEGER | 是否完成（0/1） |
| importance | INTEGER | 是否重要（0/1） |

### 4.3 类设计

1. **ToDoItem类**：任务数据模型
   - 属性：id、TaskContent、TaskDate、done、importance
   - 方法：getter/setter、getValue()（转换为ContentValues）

2. **MyDBHelper类**：数据库操作类（继承SQLiteOpenHelper）
   - 方法：insert()、update()、queryAll()、queryByKeyword()、queryByID()

3. **MainActivity类**：主界面Activity
   - 功能：显示任务列表、搜索、跳转到详情页

4. **TaskDetailActivity类**：任务详情Activity
   - 功能：添加新任务、编辑已有任务、选择日期

5. **ToDoAdapter类**：自定义Adapter（继承ArrayAdapter）
   - 功能：自定义ListView列表项的显示

## 五、功能实现

### 5.1 主界面实现（MainActivity）

#### 5.1.1 界面布局

主界面包含以下组件：
- 标题栏："To Do List"
- 搜索框和查询按钮
- 添加任务按钮
- ListView列表（显示所有任务）

#### 5.1.2 核心功能

1. **数据加载**：`loadData()`方法从数据库查询所有任务并显示在ListView中

```java
private void loadData() {
    this.to_do_list = db.queryAll();
    adapter = new ToDoAdapter(this, R.layout.to_to_item, this.to_do_list);
    this.to_do_list_view.setAdapter(adapter);
}
```

2. **搜索功能**：根据关键词在任务内容中模糊搜索

```java
search.setOnClickListener(v->{
    String key = et_input.getText().toString();
    if(key.isEmpty()){
        loadData();
        return;
    }
    this.to_do_list = db.queryByKeyword(key);
    adapter.updateData(this.to_do_list);
});
```

3. **列表项点击**：点击列表项跳转到任务详情页，并传递任务数据

4. **添加任务**：点击"添加任务"按钮跳转到详情页（添加模式）

5. **生命周期管理**：在`onResume()`中重新加载数据，确保从详情页返回时数据是最新的

### 5.2 任务详情界面实现（TaskDetailActivity）

#### 5.2.1 界面布局

详情界面包含：
- 任务内容输入框
- 截止日期显示和选择按钮
- 是否完成复选框
- 是否重要复选框
- 添加任务/修改任务按钮（根据模式显示）

#### 5.2.2 核心功能

1. **模式识别**：根据Intent中的`requestCode`判断是添加模式还是编辑模式

```java
int requestCode = extras.getInt("requestCode");
if(requestCode == ADD_NEW_TASK_CODE){
    addTask.setVisibility(View.VISIBLE);
    updateTask.setVisibility(View.GONE);
}else if(requestCode == UPDATE_TASK_CODE){
    addTask.setVisibility(View.GONE);
    updateTask.setVisibility(View.VISIBLE);
    // 填充已有数据
}
```

2. **日期选择**：使用`DatePickerDialog`选择任务截止日期

```java
DatePickerDialog datePickerDialog = new DatePickerDialog(
    this,
    new DatePickerDialog.OnDateSetListener() {
        @Override
        public void onDateSet(android.widget.DatePicker view, int year, int month, int dayOfMonth) {
            // 格式化日期为 "yyyy-MM-dd"
            SimpleDateFormat sdf = new SimpleDateFormat("yyyy-MM-dd", Locale.getDefault());
            selectedDateStr = sdf.format(selectedCalendar.getTime());
            taskDeadline.setText(selectedDateStr);
        }
    },
    year, month, day
);
```

3. **添加任务**：验证输入后调用数据库插入方法

4. **更新任务**：验证输入后调用数据库更新方法

### 5.3 数据库操作实现（MyDBHelper）

#### 5.3.1 数据库创建

在`onCreate()`方法中创建数据表：

```java
String sql = "CREATE TABLE "+ TABLE_NAME +" (" +
        COLUMN_ID +" INTEGER PRIMARY KEY AUTOINCREMENT," +
        COLUMN_TASK_CONTENT +" TEXT," +
        COLUMN_TASK_DATE+" TEXT," +
        COLUMN_DONE + " INTEGER," +
        COLUMN_IMPORTANCE + " INTEGER)";
db.execSQL(sql);
```

#### 5.3.2 数据操作方法

1. **insert()**：插入新任务，返回插入的行ID
2. **update()**：根据ID更新任务，返回更新的行数
3. **queryAll()**：查询所有任务，按ID排序
4. **queryByKeyword()**：根据关键词模糊查询任务内容
5. **queryByID()**：根据ID查询单个任务

所有数据库操作都使用了try-finally确保Cursor和Database正确关闭，避免资源泄漏。

### 5.4 列表适配器实现（ToDoAdapter）

#### 5.4.1 自定义显示

在`getView()`方法中自定义每个列表项的显示：

1. **重要性显示**：根据`isImportance()`决定显示实心星标还是空心星标

```java
if(item.isImportance()){
    start_image.setImageResource(ToDoItem.STAR_IMAGE_ID);
}else{
    start_image.setImageResource(ToDoItem.EMPTY_IMAGE_ID);
}
```

2. **完成状态显示**：已完成的任务添加删除线效果

```java
if(item.isDone()){
    task_content.setPaintFlags(task_content.getPaintFlags() | Paint.STRIKE_THRU_TEXT_FLAG);
}
```

3. **数据更新**：`updateData()`方法用于更新列表数据并刷新显示

## 六、核心代码分析

### 6.1 Activity间数据传递

使用Intent和Bundle在Activity之间传递数据：

**MainActivity → TaskDetailActivity（查看模式）**：
```java
Intent intent = new Intent(MainActivity.this, TaskDetailActivity.class);
Bundle bundle = new Bundle();
bundle.putInt("requestCode", REQUEST_VEW_TASK_CODE);
bundle.putString("taskContent", item.getTaskContent());
bundle.putBoolean("isDone", item.isDone());
bundle.putBoolean("isImportant", item.isImportance());
bundle.putString("task_date", item.getTaskDate());
bundle.putLong("ID", item.getId());
intent.putExtras(bundle);
startActivity(intent);
```

### 6.2 数据库查询优化

使用参数化查询防止SQL注入，并使用LIKE进行模糊搜索：

```java
cursor = db.query(TABLE_NAME,
    new String[]{COLUMN_ID, COLUMN_TASK_CONTENT, COLUMN_TASK_DATE, COLUMN_DONE, COLUMN_IMPORTANCE},
    COLUMN_TASK_CONTENT + " LIKE ?",
    new String[]{"%"+ keyword + "%"},
    null, null, COLUMN_ID
);
```

### 6.3 资源管理

所有数据库操作都正确关闭了Cursor和Database：

```java
try{
    // 数据库操作
}finally {
    if(cursor != null && !cursor.isClosed()){
        cursor.close();
    }
    if(db != null && db.isOpen()){
        db.close();
    }
}
```

## 七、实验结果

### 7.1 功能测试

1. ✅ **添加任务**：可以成功添加新任务，包含内容、日期、完成状态、重要性
2. ✅ **查看任务列表**：主界面正确显示所有任务
3. ✅ **编辑任务**：点击列表项可以查看和编辑任务详情
4. ✅ **更新任务**：修改任务信息后可以成功保存
5. ✅ **搜索功能**：可以根据关键词搜索任务
6. ✅ **UI显示**：
   - 重要任务显示实心星标（star_full.png）
   - 普通任务显示空心星标（star_empty.png）
   - 已完成任务显示删除线
   - 任务日期正确显示

<video src="./res/功能演示.mp4"/>

### 7.2 数据持久化测试

- ✅ 应用关闭后重新打开，数据仍然存在
- ✅ 数据库操作正常，无异常抛出
- ✅ 数据更新后立即反映在界面上

![](./res/数据库内容展示.png)

---

**实验完成日期**：2024年

**学生姓名**：董一坤

**学号**：42312240

